generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  LECTURER
}

model User {
  id       Int     @id @default(autoincrement())
  name     String
  email    String  @unique
  password String
  role     Role
  phone    String?
  profileImageUrl String?

  courses          Course[]          @relation("LecturerCourses")
  enrollments      Enrollment[]
  submissions      Submission[]
  quizSubmissions  QuizSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Course {
  id          Int     @id @default(autoincrement())
  title       String
  description String?
  imageUrl    String?
  code        String?

  lecturerId Int
  lecturer   User @relation("LecturerCourses", fields: [lecturerId], references: [id])

  enrollments Enrollment[]
  assignments Assignment[]
  quizzes     Quiz[]
  modules     CourseModule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Enrollment {
  id Int @id @default(autoincrement())

  studentId Int
  courseId  Int
  semester  String?
  status    String?

  student User   @relation(fields: [studentId], references: [id])
  course  Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, courseId])
}

model Assignment {
  id          String @id @default(uuid())
  title       String
  description String
  code        String?
  brief       String?
  dueDate     DateTime?

  courseId Int
  course   Course @relation(fields: [courseId], references: [id])

  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SubmissionStatus {
  SUBMITTED
  GRADED
  REJECTED
}

enum ModuleType {
  PPT
  PDF
  VIDEO
  OTHER
}

model Submission {
  id String @id @default(uuid())

  assignmentId String
  studentId    Int

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation(fields: [studentId], references: [id])

  fileUrl     String
  status      SubmissionStatus @default(SUBMITTED)
  grade       Float?
  feedback    String?
  submittedAt DateTime @default(now())
  gradedAt    DateTime?

  @@unique([assignmentId, studentId])
}

model Quiz {
  id          String @id @default(cuid())
  title       String
  description String?
  duration    Int?    // Durasi dalam menit (optional)

  courseId Int
  course   Course @relation(fields: [courseId], references: [id])

  questions   Question[]
  submissions QuizSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model Question {
  id       String @id @default(cuid())
  question String
  optionA  String
  optionB  String
  optionC  String
  optionD  String
  correctAnswer String // 'A', 'B', 'C', atau 'D'
  order    Int    // Urutan pertanyaan

  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  answers QuizAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([quizId])
}

model QuizSubmission {
  id String @id @default(cuid())

  quizId    String
  studentId Int

  quiz    Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student User @relation(fields: [studentId], references: [id])

  answers        QuizAnswer[]
  score          Float        // Nilai akhir (0-100)
  correctCount   Int          // Jumlah jawaban benar
  totalQuestions Int          // Total pertanyaan
  submittedAt    DateTime     @default(now())

  @@unique([quizId, studentId])
  @@index([quizId])
  @@index([studentId])
}

model QuizAnswer {
  id String @id @default(cuid())

  submissionId String
  questionId   String

  submission QuizSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   Question       @relation(fields: [questionId], references: [id])

  selectedAnswer String // 'A', 'B', 'C', atau 'D'
  isCorrect      Boolean

  @@unique([submissionId, questionId])
  @@index([submissionId])
  @@index([questionId])
}

model CourseModule {
  id          String     @id @default(cuid())
  title       String
  description String?
  fileUrl     String
  fileType    ModuleType

  courseId Int
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}
